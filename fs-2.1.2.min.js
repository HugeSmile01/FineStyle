const FineStyle = (() => {
  // ----- Core Utilities -----
  const utils = {
    debounce: (func, wait = 300) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }
  };

  // ----- Extended State Management -----
  class EnhancedStore {
    constructor() {
      this.state = {
        theme: localStorage.getItem('fs-theme') || 'light',
        activeComponent: null,
        contextMenu: { visible: false, x: 0, y: 0 }
      };
      
      this.proxy = new Proxy(this.state, {
        set: (target, key, value) => {
          target[key] = value;
          this._handleStateUpdate(key, value);
          return true;
        }
      });
    }
    
    _handleStateUpdate(key, value) {
      switch(key) {
        case 'theme':
          document.documentElement.setAttribute('data-theme', value);
          localStorage.setItem('fs-theme', value);
          break;
        case 'contextMenu':
          value.visible ? this._showContextMenu(value) : this._hideContextMenu();
          break;
      }
    }
    
    _showContextMenu({ x, y, items }) {
      const menu = document.createElement('div');
      menu.className = 'fs-context-menu';
      menu.style = `position: fixed; left: ${x}px; top: ${y}px`;
      
      items.forEach(({ label, action }) => {
        const item = document.createElement('div');
        item.className = 'fs-menu-item';
        item.textContent = label;
        item.addEventListener('click', action);
        menu.appendChild(item);
      });
      
      document.body.appendChild(menu);
    }
    
    _hideContextMenu() {
      const menus = document.querySelectorAll('.fs-context-menu');
      menus.forEach(menu => menu.remove());
    }
  }

  // ----- Command System Implementation -----
  class CommandSystem {
    constructor() {
      this.commands = new Map();
      this._initKeyboardShortcuts();
      this.registerCoreCommands();
    }

    register(name, callback) {
      this.commands.set(name, { name, callback });
    }

    _initKeyboardShortcuts() {
      document.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 'k') {
          e.preventDefault();
          this.show();
        }
      });
    }

    registerCoreCommands() {
      this.register('toggle-theme', () => FineStyle.toggleTheme());
      this.register('open-terminal', () => new FineStyle.Terminal('#terminal'));
    }

    show() {
      const palette = document.createElement('div');
      palette.className = 'fs-command-palette';
      palette.innerHTML = `
        <input class="fs-command-input" placeholder="Type command...">
        <div class="fs-command-list"></div>
      `;
      document.body.appendChild(palette);
      this._bindEvents(palette);
    }

    _bindEvents(palette) {
      const input = palette.querySelector('.fs-command-input');
      input.addEventListener('input', e => this._filterCommands(e.target.value));
      input.focus();
    }

    _filterCommands(query) {
      const list = document.querySelector('.fs-command-list');
      list.innerHTML = '';
      
      Array.from(this.commands.values())
        .filter(cmd => cmd.name.includes(query.toLowerCase()))
        .forEach(cmd => {
          const item = document.createElement('div');
          item.className = 'fs-command-item';
          item.textContent = cmd.name;
          item.addEventListener('click', cmd.callback);
          list.appendChild(item);
        });
    }
  }

  // ----- Public API -----
  return {
    Store: new EnhancedStore(),
    Commands: new CommandSystem(),
    utils,
    
    init() {
      components.initAdvanced();
      document.dispatchEvent(new Event('fs-init'));
    },
    
    toggleTheme() {
      this.Store.proxy.theme = this.Store.proxy.theme === 'light' ? 'dark' : 'light';
    },
    
    registerComponent(name, config) {
      const tagName = `fs-${name}`;
      if (!customElements.get(tagName)) {
        customElements.define(tagName, class extends HTMLElement {
          constructor() { 
            super();
            config.constructor?.(this); 
          }
          connectedCallback() { 
            config.onMount?.(this); 
          }
          disconnectedCallback() { 
            config.onUnmount?.(this); 
          }
        });
      }
    },
    
    animate
  };
})();

// ----- Global Initialization -----
document.addEventListener('DOMContentLoaded', () => {
  window.FineStyle = FineStyle;
  FineStyle.init();
  
  // Context Menu Setup
  FineStyle.ContextMenu = new ContextMenuSystem();
  FineStyle.ContextMenu.add('New File', () => console.log('New file created'));
  FineStyle.ContextMenu.add('Open Terminal', () => new FineStyle.Terminal('#terminal'));
  
  // Command Palette Setup
  FineStyle.Commands.register('toggle-theme', () => FineStyle.toggleTheme());
  FineStyle.Commands.register('open-terminal', () => new FineStyle.Terminal('#terminal'));

  // Side Knob Functionality
  const menuToggle = document.querySelector('.menu-toggle');
  const navLinks = document.querySelector('.nav-links');

  menuToggle.addEventListener('click', () => {
    navLinks.classList.toggle('active');
  });

  // Smooth Scrolling
  const smoothScroll = (target, duration) => {
    const targetElement = document.querySelector(target);
    const targetPosition = targetElement.getBoundingClientRect().top;
    const startPosition = window.pageYOffset;
    const startTime = null;

    const ease = (t, b, c, d) => {
      t /= d / 2;
      if (t < 1) return c / 2 * t * t + b;
      t--;
      return -c / 2 * (t * (t - 2) - 1) + b;
    };

    const animation = currentTime => {
      if (startTime === null) startTime = currentTime;
      const timeElapsed = currentTime - startTime;
      const run = ease(timeElapsed, startPosition, targetPosition, duration);
      window.scrollTo(0, run);
      if (timeElapsed < duration) requestAnimationFrame(animation);
    };

    requestAnimationFrame(animation);
  };

  document.querySelectorAll('.nav-links a').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      e.preventDefault();
      const target = this.getAttribute('href');
      smoothScroll(target, 1000);
    });
  });

  // Scrollspy Feature
  const sections = document.querySelectorAll('section');
  const navItems = document.querySelectorAll('.fs-nav-item');

  window.addEventListener('scroll', () => {
    let current = '';

    sections.forEach(section => {
      const sectionTop = section.offsetTop;
      if (pageYOffset >= sectionTop - 60) {
        current = section.getAttribute('id');
      }
    });

    navItems.forEach(item => {
      item.classList.remove('active');
      if (item.getAttribute('href').includes(current)) {
        item.classList.add('active');
      }
    });
  });

  // Initialize Feather Icons
  feather.replace();
});

// ----- Responsive Handling -----
window.addEventListener('resize', FineStyle.utils.debounce(() => {
  document.dispatchEvent(new Event('fs-resize'));
}));

// Implement ARIA attributes to improve the accessibility of dynamic content and interactive elements
document.querySelectorAll('.fs-context-menu').forEach(menu => {
  menu.setAttribute('role', 'menu');
  menu.querySelectorAll('.fs-menu-item').forEach(item => {
    item.setAttribute('role', 'menuitem');
  });
});

// Ensure sufficient color contrast between text and background colors to improve readability for users with visual impairments
document.querySelectorAll('.fs-menu-item').forEach(item => {
  item.style.color = 'var(--surface-900)';
  item.style.backgroundColor = 'var(--surface-0)';
});

// Provide alternative text for images and icons to assist screen readers
document.querySelectorAll('img').forEach(img => {
  if (!img.alt) {
    img.alt = 'Image';
  }
});

// Implement keyboard navigation to allow users to navigate through the interface using the keyboard
document.addEventListener('keydown', e => {
  if (e.key === 'Tab') {
    const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    const firstFocusableElement = document.querySelectorAll(focusableElements)[0];
    const focusableContent = document.querySelectorAll(focusableElements);
    const lastFocusableElement = focusableContent[focusableContent.length - 1];

    if (e.shiftKey) {
      if (document.activeElement === firstFocusableElement) {
        lastFocusableElement.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === lastFocusableElement) {
        firstFocusableElement.focus();
        e.preventDefault();
      }
    }
  }
});

// Ensure form controls have associated labels and use appropriate input types
document.querySelectorAll('input, textarea').forEach(input => {
  if (!input.labels.length) {
    const label = document.createElement('label');
    label.textContent = input.placeholder || 'Input';
    input.parentNode.insertBefore(label, input);
  }
});

// Test the design with screen readers and other assistive technologies to identify and address any accessibility issues
// This step requires manual testing with screen readers and other assistive technologies.

// Implement additional media queries for various screen sizes
const mediaQueries = [
  { query: '(max-width: 1200px)', callback: () => console.log('Screen width is 1200px or less') },
  { query: '(max-width: 992px)', callback: () => console.log('Screen width is 992px or less') },
  { query: '(max-width: 768px)', callback: () => console.log('Screen width is 768px or less') },
  { query: '(max-width: 576px)', callback: () => console.log('Screen width is 576px or less') }
];

mediaQueries.forEach(({ query, callback }) => {
  const mediaQueryList = window.matchMedia(query);
  mediaQueryList.addListener(e => {
    if (e.matches) {
      callback();
    }
  });
  if (mediaQueryList.matches) {
    callback();
  }
});

// Ensure all components adapt well to different devices and orientations
const adaptComponents = () => {
  const components = document.querySelectorAll('.fs-component');
  components.forEach(component => {
    if (window.innerWidth < 768) {
      component.classList.add('mobile');
    } else {
      component.classList.remove('mobile');
    }
  });
};

window.addEventListener('resize', adaptComponents);
document.addEventListener('DOMContentLoaded', adaptComponents);

// Test the design on multiple devices to identify and fix any responsiveness issues
const testResponsiveness = () => {
  const devices = [
    { name: 'iPhone 6/7/8', width: 375, height: 667 },
    { name: 'iPad', width: 768, height: 1024 },
    { name: 'Desktop', width: 1440, height: 900 }
  ];

  devices.forEach(device => {
    window.resizeTo(device.width, device.height);
    console.log(`Testing on ${device.name}`);
    // Add your testing logic here
  });
};

testResponsiveness();
